"""Evolved strategy: Token Budget Enforcer

Auto-generated by agos evolution engine.
Source paper: 2602.15813v1
Target module: policy
Generated: 2026-02-18T02:13:05.002078
Defines: TokenBudget

Sandbox output: Budget: used=1150, violations=1, util=1.15
PASS: Token budget enforcer validated

"""

from __future__ import annotations

from typing import Any

from agos.evolution.integrator import IntegrationStrategy, EvolutionProposal


# ── Evolved pattern code ──────────────────────────────────────────
# This code passed sandbox validation before being written here.

class TokenBudget:
    def __init__(self, limit, burst_factor=1.5):
        self.limit = limit
        self.burst_limit = int(limit * burst_factor)
        self.used = 0
        self.violations = 0
    def request(self, tokens):
        if self.used + tokens > self.burst_limit:
            self.violations += 1
            return False
        self.used += tokens
        return True
    def decay(self, factor=0.8):
        self.used = int(self.used * factor)
    @property
    def utilization(self):
        return round(self.used / self.limit, 3) if self.limit else 0

b = TokenBudget(limit=1000, burst_factor=1.5)
assert b.request(500)
assert b.request(400)
assert b.utilization == 0.9
assert not b.request(700)
assert b.violations == 1
b.decay(0.5)
assert b.request(700)
print(f'Budget: used={b.used}, violations={b.violations}, util={b.utilization}')
print('PASS: Token budget enforcer validated')


# ── Strategy wrapper ──────────────────────────────────────────────


class TokenBudgetEnforcerStrategy(IntegrationStrategy):
    """Evolved strategy wrapping: Token Budget Enforcer"""

    name = "token_budget_enforcer"
    target_module = "policy"

    def __init__(self, **kwargs: Any) -> None:
        self._kwargs = kwargs
        self._applied = False

    def validate(self, proposal: EvolutionProposal) -> tuple[bool, str]:
        return True, ""

    async def snapshot(self) -> dict[str, Any]:
        return {"applied": self._applied}

    async def apply(self, proposal: EvolutionProposal) -> list[str]:
        self._applied = True
        return [
            "Applied evolved pattern: Token Budget Enforcer",
            "Source: 2602.15813v1",
        ]

    async def rollback(self, snapshot_data: dict[str, Any]) -> None:
        self._applied = snapshot_data.get("applied", False)

    async def health_check(self) -> bool:
        return True
