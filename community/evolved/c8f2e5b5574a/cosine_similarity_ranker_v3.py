"""Evolved strategy: Cosine Similarity Ranker

Auto-generated by agos evolution engine.
Source paper: 2602.15021v1
Target module: knowledge.semantic
Generated: 2026-02-17T03:23:20.731665
Defines: tfidf_vector, cosine_sim

Sandbox output: Rankings: [(0, 0.816), (3, 0.816), (1, 0.0), (2, 0.0)]
PASS: Cosine similarity ranker validated

"""

from __future__ import annotations

from typing import Any

from agos.evolution.integrator import IntegrationStrategy, EvolutionProposal


# ── Evolved pattern code ──────────────────────────────────────────
# This code passed sandbox validation before being written here.

import math
from collections import Counter

def tfidf_vector(text, vocab):
    words = text.lower().split()
    tf = Counter(words)
    return [tf.get(w, 0) / max(len(words), 1) for w in vocab]

def cosine_sim(a, b):
    dot = sum(x * y for x, y in zip(a, b))
    na = math.sqrt(sum(x*x for x in a))
    nb = math.sqrt(sum(x*x for x in b))
    return dot / (na * nb) if na and nb else 0.0

docs = ['agent memory retrieval', 'semantic search vectors',
        'policy engine rules', 'agent memory search']
vocab = sorted(set(' '.join(docs).lower().split()))
query_vec = tfidf_vector('agent memory', vocab)
scores = [(i, round(cosine_sim(query_vec, tfidf_vector(d, vocab)), 3)) for i, d in enumerate(docs)]
scores.sort(key=lambda x: -x[1])
assert scores[0][1] > scores[-1][1]
print(f'Rankings: {scores}')
print('PASS: Cosine similarity ranker validated')


# ── Strategy wrapper ──────────────────────────────────────────────


class CosineSimilarityRankerStrategy(IntegrationStrategy):
    """Evolved strategy wrapping: Cosine Similarity Ranker"""

    name = "cosine_similarity_ranker"
    target_module = "knowledge.semantic"

    def __init__(self, **kwargs: Any) -> None:
        self._kwargs = kwargs
        self._applied = False

    def validate(self, proposal: EvolutionProposal) -> tuple[bool, str]:
        return True, ""

    async def snapshot(self) -> dict[str, Any]:
        return {"applied": self._applied}

    async def apply(self, proposal: EvolutionProposal) -> list[str]:
        self._applied = True
        return [
            "Applied evolved pattern: Cosine Similarity Ranker",
            "Source: 2602.15021v1",
        ]

    async def rollback(self, snapshot_data: dict[str, Any]) -> None:
        self._applied = snapshot_data.get("applied", False)

    async def health_check(self) -> bool:
        return True
