"""Evolved strategy: Message Channel Router

Auto-generated by agos evolution engine.
Source paper: 2602.15019v1
Target module: coordination
Generated: 2026-02-17T03:00:34.431397
Defines: Channel

Sandbox output: findings -> ['reviewer'], broadcast -> ['researcher', 'reviewer']
PASS: Message channel router validated

"""

from __future__ import annotations

from typing import Any

from agos.evolution.integrator import IntegrationStrategy, EvolutionProposal


# ── Evolved pattern code ──────────────────────────────────────────
# This code passed sandbox validation before being written here.

from collections import defaultdict

class Channel:
    def __init__(self, name):
        self.name = name
        self.subscribers = defaultdict(list)
        self.history = []
    def subscribe(self, agent, topics):
        for t in topics:
            self.subscribers[t].append(agent)
    def send(self, topic, msg, sender):
        self.history.append({'topic': topic, 'msg': msg, 'sender': sender})
        receivers = self.subscribers.get(topic, [])
        return [r for r in receivers if r != sender]
    def broadcast(self, msg, sender):
        all_agents = set()
        for agents in self.subscribers.values():
            all_agents.update(agents)
        all_agents.discard(sender)
        self.history.append({'topic': '*', 'msg': msg, 'sender': sender})
        return sorted(all_agents)

ch = Channel('team-alpha')
ch.subscribe('researcher', ['findings', 'requests'])
ch.subscribe('coder', ['requests', 'reviews'])
ch.subscribe('reviewer', ['reviews', 'findings'])
r1 = ch.send('findings', 'found paper', 'researcher')
assert 'reviewer' in r1 and 'researcher' not in r1
r2 = ch.broadcast('done', 'coder')
assert 'researcher' in r2 and 'reviewer' in r2
print(f'findings -> {r1}, broadcast -> {r2}')
print('PASS: Message channel router validated')


# ── Strategy wrapper ──────────────────────────────────────────────


class MessageChannelRouterStrategy(IntegrationStrategy):
    """Evolved strategy wrapping: Message Channel Router"""

    name = "message_channel_router"
    target_module = "coordination"

    def __init__(self, **kwargs: Any) -> None:
        self._kwargs = kwargs
        self._applied = False

    def validate(self, proposal: EvolutionProposal) -> tuple[bool, str]:
        return True, ""

    async def snapshot(self) -> dict[str, Any]:
        return {"applied": self._applied}

    async def apply(self, proposal: EvolutionProposal) -> list[str]:
        self._applied = True
        return [
            "Applied evolved pattern: Message Channel Router",
            "Source: 2602.15019v1",
        ]

    async def rollback(self, snapshot_data: dict[str, Any]) -> None:
        self._applied = snapshot_data.get("applied", False)

    async def health_check(self) -> bool:
        return True
