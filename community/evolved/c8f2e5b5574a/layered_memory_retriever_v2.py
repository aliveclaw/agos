"""Evolved strategy: Layered Memory Retriever

Auto-generated by agos evolution engine.
Source paper: 2602.16698v1
Target module: knowledge.manager
Generated: 2026-02-19T19:20:50.176560
Defines: Layer, layered_recall

Sandbox output: Layered recall: ['agent running now', 'agent completed scan', 'agent learned']
PASS: Layered retriever validated

"""

from __future__ import annotations

from typing import Any

from agos.evolution.integrator import IntegrationStrategy, EvolutionProposal


# ── Evolved pattern code ──────────────────────────────────────────
# This code passed sandbox validation before being written here.

class Layer:
    def __init__(self, name, pri, data):
        self.name, self.pri, self.data = name, pri, data
    def query(self, q, n=5):
        return [d for d in self.data if q.lower() in d.lower()][:n]

def layered_recall(layers, q, limit=10):
    out = []
    for l in sorted(layers, key=lambda x: x.pri, reverse=True):
        if len(out) >= limit: break
        out.extend(l.query(q, limit - len(out)))
    return out

w = Layer('working', 100, ['agent running now', 'current goal: evolve'])
e = Layer('episodic', 50, ['agent completed scan', 'agent learned'])
s = Layer('semantic', 10, ['agents use events', 'agent memory works'])
r = layered_recall([s, w, e], 'agent', 3)
assert len(r) == 3 and 'now' in r[0]
print(f'Layered recall: {r}')
print('PASS: Layered retriever validated')


# ── Strategy wrapper ──────────────────────────────────────────────


class LayeredMemoryRetrieverStrategy(IntegrationStrategy):
    """Evolved strategy wrapping: Layered Memory Retriever"""

    name = "layered_memory_retriever"
    target_module = "knowledge.manager"

    def __init__(self, **kwargs: Any) -> None:
        self._kwargs = kwargs
        self._applied = False

    def validate(self, proposal: EvolutionProposal) -> tuple[bool, str]:
        return True, ""

    async def snapshot(self) -> dict[str, Any]:
        return {"applied": self._applied}

    async def apply(self, proposal: EvolutionProposal) -> list[str]:
        self._applied = True
        return [
            "Applied evolved pattern: Layered Memory Retriever",
            "Source: 2602.16698v1",
        ]

    async def rollback(self, snapshot_data: dict[str, Any]) -> None:
        self._applied = snapshot_data.get("applied", False)

    async def health_check(self) -> bool:
        return True
